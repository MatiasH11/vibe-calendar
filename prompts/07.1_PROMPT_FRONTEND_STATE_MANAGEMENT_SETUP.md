### **Archivo 7.1: `07.1_PROMPT_FRONTEND_STATE_MANAGEMENT_SETUP.md`**

# Prompt: Frontend - Setup de Gestión de Estado (React Query + Zustand)

Actúa como Frontend Lead. Configura la infraestructura de gestión de estado para optimizar la UX de la planilla interactiva y el dashboard.

## Objetivo
- Configurar `@tanstack/react-query` para cache y sincronización servidor
- Implementar `zustand` para estado local del UI
- Crear hooks customizados reutilizables
- Preparar optimistic updates y error handling robusto

## Dependencias a Instalar
```bash
npm install @tanstack/react-query @tanstack/react-query-devtools zustand immer
```

## Estructura
```
providers/
  QueryProvider.tsx
  AppProviders.tsx
stores/
  planillaStore.ts
  uiStore.ts
hooks/
  useShifts.ts
  useEmployees.ts  
  useShiftMutations.ts
  useWeekNavigation.ts
  useOptimisticShifts.ts (opcional)
lib/
  queryClient.ts
  types.ts (extender si hace falta)
components/ui/
  QueryBoundary.tsx
```

## 1. Configuración Base

### providers/QueryProvider.tsx
- Client Component con `QueryClientProvider` y `HydrationBoundary`.
- Configuración recomendada:
  - `defaultOptions.queries`: `staleTime: 5 * 60 * 1000`, `refetchOnWindowFocus: false`, `refetchOnReconnect: true`
  - Manejo global de errores (log + toasts opcionales en capturas específicas).
- Montar `ReactQueryDevtools` en desarrollo.

### providers/AppProviders.tsx
- Client Component que envuelve `{children}` con `<QueryProvider>` y `<Toaster />` de `sonner`.

### lib/queryClient.ts  
- Exporta una factoría de `QueryClient` con defaults y `mutationCache` con manejo de errores.

## 2. Stores Zustand

### stores/planillaStore.ts (ejemplo de interfaz)
```ts
interface PlanillaState {
  currentWeekStart: Date;
  editingShift: { employeeId: number; date: string } | null;
  isCreatingShift: boolean;
  isDragging: boolean;
  setCurrentWeek: (date: Date) => void;
  setEditingShift: (shift: { employeeId: number; date: string } | null) => void;
}
```

### stores/uiStore.ts
- Loading states globales, cola de toasts, preferencias UI.

## 3. Hooks de Datos

### hooks/useEmployees.ts
```ts
export const useEmployees = () => {
  return useQuery({
    queryKey: ['employees'],
    queryFn: () => api.get<Employee[]>('/employees'),
    staleTime: 5 * 60 * 1000,
  });
};
```

### hooks/useShifts.ts
```ts
export const useShifts = (startDate: string, endDate: string) => {
  return useQuery({
    queryKey: ['shifts', startDate, endDate],
    queryFn: () => api.get<Shift[]>(`/shifts?start_date=${startDate}&end_date=${endDate}`),
    staleTime: 30 * 1000,
    enabled: !!(startDate && endDate),
  });
};
```

## 4. Mutaciones con Optimistic Updates

### hooks/useShiftMutations.ts (patrón recomendado)
```ts
export const useShiftMutations = ({ startDate, endDate }: { startDate: string; endDate: string }) => {
  const queryClient = useQueryClient();
  const key = ['shifts', startDate, endDate];

  const createShift = useMutation({
    mutationFn: (newShift: CreateShiftDTO) => api.post<Shift>('/shifts', newShift),
    onMutate: async (newShift) => {
      await queryClient.cancelQueries({ queryKey: key });
      const previous = queryClient.getQueryData<Shift[]>(key) ?? [];
      queryClient.setQueryData<Shift[]>(key, [...previous, { ...newShift, id: -Date.now() } as any]);
      return { previous };
    },
    onError: (_err, _vars, ctx) => {
      if (ctx?.previous) queryClient.setQueryData(key, ctx.previous);
    },
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: key });
    },
  });

  // Implementar updateShift y deleteShift con el mismo patrón (optimista + invalidate)

  return { createShift };
};
```

## 5. Integración con Layout

### Modificar `app/(app)/layout.tsx`
- Envolver `{children}` con `<AppProviders>`.
- Añadir React Query DevTools en desarrollo (dentro de providers).

## 6. Error Boundaries y Loading States

### components/ui/QueryBoundary.tsx
- Error boundary específico para queries con retry y fallback amigable.

## Salida Esperada
- `providers/QueryProvider.tsx`
- `providers/AppProviders.tsx` 
- `stores/planillaStore.ts`
- `stores/uiStore.ts`
- `hooks/useShifts.ts`
- `hooks/useEmployees.ts`
- `hooks/useShiftMutations.ts`
- `lib/queryClient.ts`
- `components/ui/QueryBoundary.tsx`
- `app/(app)/layout.tsx` (modificado para envolver con AppProviders)


